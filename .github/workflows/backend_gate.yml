name: backend-gate

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: CI Ping
        run: |
          echo "branch=$GITHUB_REF_NAME"
          echo "sha=$GITHUB_SHA"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      # We keep backend-only gates light + reliable:
      # - install deps (supports requirements.txt or pyproject.toml)
      # - run alembic if present (SQLite DB for CI)
      # - run pytest if present, else do a smoke import/compile pass
      - name: Install backend deps
        run: |
          set -euo pipefail
          cd backend

          python -m pip install --upgrade pip

          pip install -r requirements.txt

      - name: Alembic upgrade (SQLite CI DB) if present
        env:
          # Generic env var many apps read; harmless if unused
          DATABASE_URL: sqlite:///./ci_test.db
          FLASK_ENV: development
        run: |
          set -euo pipefail
          cd backend

          if [ -f "alembic.ini" ] || [ -f "migrations/alembic.ini" ] || [ -d "migrations" ]; then
            python -m pip install alembic >/dev/null 2>&1 || true

            if python -m alembic --help >/dev/null 2>&1; then
              # Prefer explicit alembic config if present
              if [ -f "migrations/alembic.ini" ]; then
                python -m alembic -c migrations/alembic.ini upgrade head
                python -m alembic -c migrations/alembic.ini current || true
              elif [ -f "alembic.ini" ]; then
                python -m alembic -c alembic.ini upgrade head
                python -m alembic -c alembic.ini current || true
              else
                echo "Alembic config not found; skipping migrations step."
              fi
            else
              echo "Alembic not available; skipping migrations step."
            fi
          else
            echo "No alembic.ini or migrations/ found; skipping migrations step."
          fi

      - name: Backend tests (pytest if available, else smoke compile/import)
        env:
          DATABASE_URL: sqlite:///./ci_test.db
          FLASK_ENV: development
        run: |
          set -euo pipefail
          cd backend

          if ls -1 tests test 2>/dev/null | grep -q .; then
            python -m pip install pytest >/dev/null 2>&1 || true
            python -m pytest -q
          else
            echo "No tests/ directory found. Running compileall smoke pass."
            python -m compileall -q .
          fi
